{
    "name": "Enhanced SMS Conversation",

    "namespace": "Stanford\\EnhancedSMSConversation",

    "description": "This module mimics the built-in REDCap SMS survey conversation but adds more flexibility around reminders, expiration, and custom context based on event/instance.",

    "documentation": "README.md",

    "framework-version": 11,

    "authors": [
        {
            "name": "Andrew Martin",
            "email": "andy123@stanford.edu",
            "institution": "Stanford"
        },
        {
            "name": "Jae Lee",
            "email": "jael@stanford.edu",
            "institution": "Stanford"
        }
    ],

    "permissions": [
        "redcap_email",
        "redcap_module_link_check_display"
    ],

    "enable-every-page-hooks-on-system-pages": false,

    "links": {
        "project": [
            {
                "name": "Enhanced SMS Conversation",
                "icon": "fas fa-cog",
                "url": "pages/detail.php"
            },
            {
                "name": "ESMS Conversations",
                "icon": "fas fa-cog",
                "url": "pages/conversations.php",
                "show-header-and-footer": true
            },
            {
                "name": "ESMS: Superuser Testing",
                "superuseronly": true,
                "icon": "fas fa-cog",
                "url": "pages/test.php"
            },
            {
                "name": "Enhanced SMS Conversation: test",
                "icon": "fas fa-cog",
                "url": "test.php"
            }
        ],
        "control-center": [

        ]
    },

    "no-auth-pages": [
        "pages/inbound"
    ],

    "no-csrf-pages": [
        "pages/inbound"
    ],

    "auth-ajax-actions": [
        "getConversations",
        "deleteConversations"
    ],

    "crons": [
        {
            "cron_name": "esms_scan_conversation_state",
            "cron_description": "This cron will run once a minute to check whether a reminder or expiry needs to go out to any existing conversations",
            "method": "cronScanConversationState",
            "cron_frequency": "60",
            "cron_max_run_time": "60"
        }
    ],

    "enable-no-auth-logging": true,

    "enable-email-hook-in-system-contexts":  true,

    "project-settings": [
        {
            "key": "phone-field",
            "name": "<b>Phone Field</b><br>Field containing the participants phone number validated as a phone number.",
            "required": true,
            "type": "field-list"
        },
        {
            "key": "phone-field-event-id",
            "name": "<b>Phone Field Event</b><br>If project is longitudinal, please select the event containing the phone field",
            "required": false,
            "type": "event-list"
        },
        {
            "key": "twilio-config-section",
            "name": "<div class='btn btn-sm btn-success'>Twilio Settings</div>",
            "type": "descriptive"
        },
        {
            "key": "twilio-sid",
            "name": "<b>Twilio API SID</b>",
            "required": true,
            "type": "text"
        },
        {
            "key": "twilio-token",
            "name": "<b>Twilio API Token</b>",
            "required": true,
            "type": "password"
        },
        {
            "key": "twilio-number",
            "name": "<b>Twilio Number</b><br>In E.164 format, e.g. +16508675309",
            "required": true,
            "type": "text"
        },
        {
            "key": "customizations",
            "name": "<div class='btn btn-sm btn-success'>Communication Customization and Preferences</div><br><i>These are default values.  Many of them can be changed on a per-survey or per-field basis. Form-level tags must be applied to the FIRST FORM in the survey</i>",
            "type": "descriptive"
        },
        {
            "key": "question-asking-style",
            "name": "<b>Question Style</b><br>When first asking a survey question, this module can read the question label only, or, for enumerated fields, it can also include the instructions.  Example instructions for a radio/select/dropdown field might be: <code>`1` for Yes or `2` for No</cod>.  See README for more details",
            "required": true,
            "default": "low",
            "type": "dropdown",
            "choices": [
                { "value": "low", "name": "Question Label only (default)" },
                { "value": "high", "name": "Question Label + Instructions" }
            ]
        },
        {
            "key": "invalid-response-style",
            "name": "<b>Invalid Response Style</b><br>When someone replies with an invalid response you can control how the module replies.  See README for more details",
            "required": true,
            "default": "medium",
            "type": "dropdown",
            "choices": [
                { "value": "low", "name": "Invalid Response Message only" },
                { "value": "medium", "name": "Invalid Response Message + Question Label (default)" },
                { "value": "high", "name": "Invalid Response Message + Question Label + Instructions (if radio/select/dropdown or validated text)" }
            ]
        },        {
            "key": "reminder-style",
            "name": "<b>Reminder Response Style</b><br>When someone fails to respond and a reminder is sent, you can control what content is sent in the message.  See README for more details",
            "required": true,
            "default": "medium",
            "type": "dropdown",
            "choices": [
                { "value": "low", "name": "Reminder message only" },
                { "value": "medium", "name": "Reminder message + Question Label (default)" }
            ]
        },

        {
            "key": "default-reminder-text",
            "name": "<b>Default Reminder Message</b><br>Send this reminder text after the time below has elapsed.<br><i>Override with:</i> <code>@ESMS-REMINDER-MESSAGE=\"My Reminder\"</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "default-reminder-minutes",
            "name": "<b>Default Reminder Time <u>in Minutes</u></b><br>Send a reminder if no reply in a conversation for this many minutes.  Set to 0 for no reminders<br><i>Override with:</i> <code>@ESMS-REMINDER-TIME=\"15\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "default-reminder-max-count",
            "name": "<b>Default Maximum Number of Reminders</b><br>Maximum number of reminders for a given conversation.  0 means no reminders.<br><i>Override with:</i> <code>@ESMS-REMINDER-MAX-COUNT=\"2\"</code>",
            "required": true,
            "default" : "1",
            "type": "text"
        },
        {
            "key": "default-expiry-text",
            "name": "<b>Default Expiry Message</b><br>If an active conversation expires, this message will be sent to the user.<br><i>Override with:</i> <code>@ESMS-EXPIRY-MESSAGE=\"This survey has expired\"</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "default-expiry-minutes",
            "name": "<b>Default Expire Time in Minutes</b><br>Expire conversation after this number of minutes.  Set to 0 to never expire an open survey conversation<br><i>Override with:</i> <code>@ESMS-EXPIRY-TIME=\"15\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "invalid-response-text",
            "name": "<b>Default Invalid Response Message</b><br><br>Upon receipt of a text that does not match an expected response, this optional message can be included in the reply.  This value can be overridden on a form or per-question basis using the actiontag, <i>e.g.</i> <code>@ESMS-INVALID-RESPONSE=\"You must enter a number between 5 and 10\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "no-open-conversation-message",
            "name": "<b>No Open Conversation Message</b><br><br><i>(optional)</i> If a participant sends a SMS message when no conversation/survey is open, this message, if defined, will be sent in reply.  A good value might be: <code>All surveys are closed or expired at this time.  Please wait until your next invitation or contact the study team if you have questions.  Your message is NOT actively monitored by the study team.</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "sms-opt-out-field",
            "name": "<b>SMS Opt Out field</b><br>This must be a checkbox field with an option of '1, Opted Out'.  If unchecked, the participant is assumed to be available.  If checked, the participant has opted out and messages will no longer be delivered.  A participant can opt-out by replying with 'STOP' or 'OPT-OUT' and can opt back into messaging by replying with 'START'",
            "required": true,
            "type": "field-list"
        },
        {
            "key": "sms-opt-out-field-event-id",
            "name": "<b>SMS Opt Out field Event ID</b><br>If project is longitudinal, please select the event containing the SMS Opt Out field",
            "required": false,
            "type": "event-list"
        },
        {
            "key": "study-withdrawn-logic",
            "name": "<b>Study Withdrawn Logic</b><br><i>(Optional)</i> If specified, this LOGICAL EXPRESSION will be evaluated prior to sending outbound messages.  If the result is TRUE, the participant is deemed to be withdrawn from the study and outbound messages will not be sent.  Stopping SMS does not necessarily withdraw person from study.  If longitudinal, be sure to include event info in the logical expression.<br><i>e.g.</i><code>[event_1_arm_1][calc_withdrawn]='1'</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "disable-outgoing-sms",
            "name": "<b>Disable Outgoing Twilio SMS</b><br><i>(optional)</i> If checked, module will prevent ALL outbound SMS messages for this project regardless of record opt-out status",
            "required": true,
            "type": "checkbox"
        },
        {
            "key": "disable-incoming-sms",
            "name": "<b>Disable Incoming Twilio SMS</b><br><i>(optional)</i> If checked, module will not process inbound twilio messages",
            "required": true,
            "type": "checkbox"
        },
        {
            "key": "enable-project-debug-logging",
            "name": "<b>Enable Debug Logging</b><br><i>(optional)</i> Requires installation and configuration of emLogger",
            "required": false,
            "type": "checkbox"
        }
    ],

    "system-settings": [
        {
            "key": "ignore-cron",
            "name": "<b>Ignore Cron (system-wide)</b><i>(optional)</i> If checked, we will not run the cron method",
            "required": false,
            "type": "checkbox"
        },
        {
            "key": "enable-system-debug-logging",
            "name": "<b>Enable Debug Logging (system-wide)</b><i>(optional)</i> Requires installation and configuration of emLogger",
            "required": false,
            "type": "checkbox"
        }
    ],

    "compatibility": {
        "php-version-min": "",
        "php-version-max": "",
        "redcap-version-min": "",
        "redcap-version-max": ""
    }
}
