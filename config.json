{
    "name": "Enhanced SMS Conversation",

    "namespace": "Stanford\\EnhancedSMSConversation",

    "description": "This module mimics the built-in REDCap SMS survey conversation but adds more flexibility around reminders, expiration, and custom context based on event/instance.",

    "documentation": "README.md",

    "framework-version": 11,

    "authors": [
        {
            "name": "Andrew Martin",
            "email": "andy123@stanford.edu",
            "institution": "Stanford"
        },
        {
            "name": "Jae Lee",
            "email": "jael@stanford.edu",
            "institution": "Stanford"
        }
    ],

    "permissions": [
        "redcap_email",
        "redcap_module_link_check_display"
    ],

    "enable-every-page-hooks-on-system-pages": false,

    "links": {
        "project": [
            {
                "name": "Enhanced SMS Conversation",
                "icon": "fas fa-cog",
                "url": "pages/detail.php"
            },
            {
                "name": "ESMS Conversations",
                "icon": "fas fa-cog",
                "url": "pages/conversations.php",
                "show-header-and-footer": true
            },
            {
                "name": "ESMS: Superuser Testing",
                "superuseronly": true,
                "icon": "fas fa-cog",
                "url": "pages/test.php"
            },
            {
                "name": "Enhanced SMS Conversation: test",
                "icon": "fas fa-cog",
                "url": "test.php"
            }
        ],
        "control-center": [

        ]
    },

    "no-auth-pages": [
        "pages/inbound"
    ],

    "no-csrf-pages": [
        "pages/inbound"
    ],

    "auth-ajax-actions": [
        "getConversations",
        "deleteConversations"
    ],

    "crons": [
        {
            "cron_name": "esms_scan_conversation_state",
            "cron_description": "This cron will run once a minute to check whether a reminder or expiry needs to go out to any existing conversations",
            "method": "cronScanConversationState",
            "cron_frequency": "60",
            "cron_max_run_time": "60"
        }
    ],

    "enable-no-auth-logging": true,

    "enable-email-hook-in-system-contexts":  true,

    "project-settings": [
        {
            "key": "phone-field",
            "name": "<b>Phone Field</b><br>Field containing the participants phone number validated as a phone number.",
            "required": true,
            "type": "field-list"
        },
        {
            "key": "phone-field-event-id",
            "name": "<b>Phone Field Event</b><br>If project is longitudinal, please select the event containing the phone field",
            "required": false,
            "type": "event-list"
        },
        {
            "key": "twilio-config-section",
            "name": "<div class='btn btn-sm btn-success'>Twilio Settings</div>",
            "type": "descriptive"
        },
        {
            "key": "twilio-sid",
            "name": "<b>Twilio API SID</b>",
            "required": true,
            "type": "text"
        },
        {
            "key": "twilio-token",
            "name": "<b>Twilio API Token</b>",
            "required": true,
            "type": "password"
        },
        {
            "key": "twilio-number",
            "name": "<b>Twilio Number</b><br>In E.164 format, e.g. +16508675309",
            "required": true,
            "type": "text"
        },
        {
            "key": "customizations",
            "name": "<b><u>Set or customize the reminder and expiration messages send to survey respondents</u></b><br>You can override the default values below on a per-survey basis by adding the action-tags specified on the <b>FIRST FIELD</b> of a given survey form",
            "type": "descriptive"
        },
        {
            "key": "default-reminder-text",
            "name": "<b>Default Reminder Message</b><br>Send this reminder text after the time below has elapsed.<br><i>Override with:</i> <code>@ESMS-REMINDER-MESSAGE=\"My Reminder\"</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "default-reminder-minutes",
            "name": "<b>Default Reminder Time <u>in Minutes</u></b><br>Send a reminder if no reply in a conversation for this many minutes.  Set to 0 for no reminders<br><i>Override with:</i> <code>@ESMS-REMINDER-TIME=\"15\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "default-reminder-max-count",
            "name": "<b>Default Maximum Number of Reminders</b><br>Maximum number of reminders for a given conversation.<br><i>Override with:</i> <code>@ESMS-REMINDER-MAX-COUNT=\"0\"</code>",
            "required": true,
            "default" : "1",
            "type": "text"
        },
        {
            "key": "default-expiry-text",
            "name": "<b>Default Expiry Message</b><br>If an active conversation expires, this message will be sent to the user.<br><i>Override with:</i> <code>@ESMS-EXPIRY-MESSAGE=\"This survey has expired\"</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "default-expiry-minutes",
            "name": "<b>Default Expire Time in Minutes</b><br>Expire conversation after this number of minutes.  Set to 0 to never expire an open survey conversation<br><i>Override with:</i> <code>@ESMS-EXPIRY-TIME=\"15\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "form-custom-settings",
            "name": "<b>Customize these settings on a per-form basis</b>",
            "required": false,
            "type": "sub_settings",
            "repeatable": true,
            "sub_settings": [
                {
                    "key": "form-name",
                    "name": "<b>Form</b><br/>Customize the settings for this form",
                    "required": true,
                    "type": "form-list"
                },
                {
                    "key": "reminder-text",
                    "name": "<b>Form Reminder Message</b><br><i>(optional)</i>If there is no response for the number of minutes specified above, this reminder message will be sent.  Leave blank for default",
                    "required": false,
                    "type": "text"
                },
                {
                    "key": "reminder-minutes",
                    "name": "<b>Minutes to Reminder Text</b><br>Send a reminder if no reply in a conversation for this many minutes.  Set to 0 for no reminders",
                    "required": true,
                    "type": "text"
                },
                {
                    "key": "reminder-max-count",
                    "name": "<b>Maximum Number of Reminders</b><br>Maximum number of reminders for a conversation.  Leave blank for default",
                    "required": true,
                    "type": "text"
                },
                {
                    "key": "expiry-text",
                    "name": "<b>Form Expiry Message</b><br><i>(optional)</i>This text will be sent if a conversation is expired.  Leave blank for default",
                    "required": false,
                    "type": "text"
                },
                {
                    "key": "expiry-minutes",
                    "name": "<b>Minutes to Expire Conversation</b><br>Expire conversation after this number of minutes.  Set to 0 to never expire",
                    "required": true,
                    "type": "text"
                }
            ]
        },


        {
            "key": "thur-expiry-text",
            "name": "<b>Thursday Expiry Text</b><br>After the allowed expiry time for the Thursday survey has elapsed, this message will be sent to the user.",
            "required": true,
            "type": "text"
        },
        {
            "key": "sun-expiry-text",
            "name": "<b>Sunday Expiry Text</b><br>After the allowed expiry time for the Sunday survey has elapsed, this message will be sent to the user.",
            "required": true,
            "type": "text"
        },
        {
            "key": "nonsense-text-warning",
            "name": "<b>Default Nonsense Text Warning</b><br><br>Upon receipt of a text that does not match an expected response, this message will be included in the reply message in this format. <br> <THIS MESSAGE><CURRENT QUESTION INSTRUCTIONS><br>This value can be overridden on a per-question basis using the actiontag, <i>e.g.</i> <code>@ESMS-INVALID-RESPONSE=\"You must enter a number between 5 and 10\"</code>",
            "required": true,
            "type": "text"
        },
        {
            "key": "no-open-conversation-message",
            "name": "<b>No Open Conversation Message</b><br><br><i>(optional)</i> If a participant sends a SMS message when no conversation/survey is open, this message, if defined, will be sent in reply.  A good value might be: <code>No surveys are currently available.  Please wait until your next invitation or contact the study team.  Your responses are not actively monitored.</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "sms-opt-out-field",
            "name": "<b>SMS Opt Out field</b><br>This must be a checkbox field with an option of '1, Opted Out'.  If unchecked, the participant is assumed to be available.  If checked, the participant has opted out and messages will no longer be delivered.  A participant can opt-out by replying with 'STOP' or 'OPT-OUT' and can opt back into messaging by replying with 'START'",
            "required": true,
            "type": "field-list"
        },
        {
            "key": "sms-opt-out-field-event-id",
            "name": "<b>SMS Opt Out field Event ID</b><br>If project is longitudinal, please select the event containing the SMS Opt Out field",
            "required": false,
            "type": "event-list"
        },
        {
            "key": "study-withdrawn-logic",
            "name": "<b>Study Withdrawn Logic</b><br><i>(Optional)</i> If specified, this LOGICAL EXPRESSION will be evaluated prior to sending outbound messages.  If the result is TRUE, the participant is deemed to be withdrawn from the study and outbound messages will not be sent.  Stopping SMS does not necessarily withdraw person from study.  If longitudinal, be sure to include event info in the logical expression.<br><i>e.g.</i><code>[event_1_arm_1][calc_withdrawn]='1'</code>",
            "required": false,
            "type": "text"
        },
        {
            "key": "disable-outgoing-sms",
            "name": "<b>Disable Outgoing Twilio SMS</b><br><i>(optional)</i> If checked, module will prevent ALL outbound SMS messages for this project regardless of record opt-out status",
            "required": true,
            "type": "checkbox"
        },
        {
            "key": "disable-incoming-sms",
            "name": "<b>Disable Incoming Twilio SMS</b><br><i>(optional)</i> If checked, module will not process inbound twilio messages",
            "required": true,
            "type": "checkbox"
        },
        {
            "key": "enable-project-debug-logging",
            "name": "<b>Enable Debug Logging</b><br><i>(optional)</i> Requires installation and configuration of emLogger",
            "required": false,
            "type": "checkbox"
        }
    ],

    "system-settings": [
        {
            "key": "ignore-cron",
            "name": "<b>Ignore Cron (system-wide)</b><i>(optional)</i> If checked, we will not run the cron method",
            "required": false,
            "type": "checkbox"
        },
        {
            "key": "enable-system-debug-logging",
            "name": "<b>Enable Debug Logging (system-wide)</b><i>(optional)</i> Requires installation and configuration of emLogger",
            "required": false,
            "type": "checkbox"
        }
    ],

    "compatibility": {
        "php-version-min": "",
        "php-version-max": "",
        "redcap-version-min": "",
        "redcap-version-max": ""
    }
}
